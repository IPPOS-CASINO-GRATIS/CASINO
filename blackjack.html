<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Blackjack Online Gratis - V3 Organizzato</title>
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-J1YN9CKJS2"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-J1YN9CKJS2');
</script>
<meta name="google-adsense-account" content="ca-pub-9456850571765688">
<meta name="description" content="Gioca a Blackjack online gratis direttamente dal tuo browser. Nessuna registrazione, nessun download: solo puro divertimento con le regole ufficiali del Blackjack!" />
<style>
  @import url('https://fonts.googleapis.com/css2?family=Nunito:wght@400;700&display=swap');
  :root {
    /* Light/Green Theme */
    --bg-color: #1e5631;
    --text-color: #ffffff;
    --card-bg: white;
    --card-text-black: black;
    --card-text-red: red;
    --button-bg: #e0e0e0;
    --button-text: #333333;
    --button-hover-bg: #d0d0d0;
    --button-disabled-opacity: 0.5;
    --highlight-color: #ffeb3b;
    --border-color: rgba(255, 255, 255, 0.2);
    --panel-bg: rgba(0, 0, 0, 0.3);
    --accent-color: #4fc3f7;
    --dealer-hidden-card-bg: #8b4513;
    --font-main: 'Nunito', sans-serif;
    --result-bg-color: rgba(0, 0, 0, 0.75);
    --result-text-color: #ffffff;
    --result-win-glow: rgba(76, 175, 80, 0.8);
    --result-lose-glow: rgba(244, 67, 54, 0.8);
    --result-push-glow: rgba(255, 152, 0, 0.8);
    --details-summary-bg: rgba(0, 0, 0, 0.4); /* Sfondo per summary */
  }

  body[data-theme="dark"] {
    --bg-color: #1f1f1f;
    --text-color: #dcdcdc;
    --card-bg: #383838;
    --card-text-black: #dcdcdc;
    --card-text-red: #ff9a8f;
    --button-bg: #4a4a4a;
    --button-text: #dcdcdc;
    --button-hover-bg: #5a5a5a;
    --highlight-color: #ffd700;
    --border-color: rgba(255, 255, 255, 0.15);
    --panel-bg: rgba(255, 255, 255, 0.1);
    --accent-color: #4fc3f7;
    --dealer-hidden-card-bg: #252525;
    --details-summary-bg: rgba(255, 255, 255, 0.15); /* Sfondo per summary tema scuro */
    background-image: radial-gradient(circle at top center, hsl(0, 0%, 18%) 0%, var(--bg-color) 70%);
    background-attachment: fixed;
  }

  /* --- General Styles --- */
  body {
    font-family: var(--font-main);
    text-align: center;
    background-color: var(--bg-color);
    color: var(--text-color);
    padding-top: 15px;
    margin: 0;
    transition: background-color 0.3s, color 0.3s, background-image 0.3s;
    background-image: none;
    min-height: 100vh;
  }

  .game-container {
    max-width: 1100px;
    margin: 0 auto;
    padding: 20px;
    position: relative;
    overflow-x: hidden;
  }

  h1 { margin-bottom: 15px; }
  h2 { margin-bottom: 10px; font-size: 1.5em; text-transform: uppercase;
  letter-spacing: 1px;}

  /* --- Collapsible Sections (Details/Summary) --- */
  details {
    background-color: var(--panel-bg);
    border: 1px solid var(--border-color);
    border-radius: 10px;
    padding: 0; /* Rimosso padding qui */
    margin: 15px auto;
    max-width: 450px;
    font-size: 1em;
    box-shadow: 0 3px 6px rgba(0,0,0,0.3);
    overflow: hidden; /* Nasconde contenuto quando chiuso */
  }

  details summary {
    font-weight: bold;
    cursor: pointer;
    padding: 12px 15px; /* Padding qui */
    background-color: var(--details-summary-bg);
    list-style: none; /* Rimuove marcatore default */
    display: flex; /* Per allineare icona */
    justify-content: space-between; /* Spazio tra titolo e icona */
    align-items: center;
    border-bottom: 1px solid var(--border-color); /* Separatore */
    transition: background-color 0.2s;
  }

  details summary:hover {
      background-color: rgba(0,0,0,0.5); /* Scurisce leggermente all'hover */
  }

  details[open] summary {
      border-bottom: 1px solid var(--border-color); /* Mantiene separatore quando aperto */
  }

  details summary::-webkit-details-marker { display: none; } /* Rimuove marcatore Chrome/Safari */

  details .content-wrapper {
      padding: 15px; /* Padding per il contenuto interno */
  }

  details h3 { /* Titolo dentro il contenuto, se necessario */
      margin-top: 0;
      margin-bottom: 15px;
      color: var(--accent-color);
      font-size: 1.2em;
      text-align: center;
      border-bottom: 1px solid var(--border-color);
      padding-bottom: 8px;
  }

   /* Icona per summary (opzionale, usa ::before o ::after) */
   details summary::after {
        content: '+'; /* Icona per stato chiuso */
        font-size: 1.4em;
        font-weight: bold;
        margin-left: 10px;
        transition: transform 0.2s ease-in-out;
   }
   details[open] summary::after {
        content: '−'; /* Icona per stato aperto */
        transform: rotate(180deg);
   }

  /* --- Specific Content Styling within <details> --- */
  #utility-controls-content div,
  #stats-content div,
  #trainer-controls-content div {
      margin-bottom: 8px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 3px 0;
   }
   #utility-controls-content label, #trainer-controls-content label {
      margin-right: 15px;
      font-weight: bold;
   }
   #stats-content span:last-child, #trainer-controls-content span:last-child {
      font-weight: bold;
      color: var(--highlight-color);
   }
   #stats-content #stats-win-rate {
      color: var(--accent-color);
   }
   #reset-stats-button {
       margin-top: 10px;
       width: 100%;
   }
   #trainer-title {
       display: flex;
       justify-content: center;
       align-items: center;
       position: relative;
   }
   #hilo-info-button {
       padding: 0; margin: 0 0 0 10px; width: 24px;
       height: 24px; font-size: 15px; line-height: 22px; font-weight: bold; border-radius: 50%; background-color: var(--button-bg); color: var(--button-text); border: 1px solid var(--border-color); box-shadow: none;
       cursor: help; vertical-align: middle; transition: background-color 0.2s, border-color 0.2s; flex-shrink: 0;
   }
   #hilo-info-button:hover { background-color: var(--button-hover-bg); border-color: var(--accent-color);
   transform: none; box-shadow: none; }


  /* --- Cards Styles (Invariati) --- */
  .cards { margin: 15px auto;
  display: flex; justify-content: center; min-height: 115px; gap: 12px; flex-wrap: wrap; perspective: 1200px; }
  .card { display: inline-block;
  border: 1px solid var(--border-color); border-radius: 8px; background: var(--card-bg); width: 65px; height: 95px; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.4);
  margin: 3px; position: relative; transform-style: preserve-3d; transition: transform 0.7s cubic-bezier(0.4, 0.0, 0.2, 1); transform: rotateY(180deg);
  }
  .card-inner { position: relative; width: 100%; height: 100%; text-align: center; transform-style: preserve-3d; }
  .card-face { position: absolute;
  width: 100%; height: 100%; -webkit-backface-visibility: hidden; backface-visibility: hidden; border-radius: 8px; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 5px;
  box-sizing: border-box; }
  .card-front { background-color: var(--card-bg); background-image: linear-gradient(to bottom, rgba(255,255,255,0.05) 0%, rgba(0,0,0,0.05) 100%); color: var(--card-text-black); font-size: 22px;
  font-weight: bold; transform: rotateY(0deg); border: 1px solid rgba(0,0,0,0.1); }
  .card-back { background-color: var(--dealer-hidden-card-bg); color: var(--text-color); transform: rotateY(180deg);
  background-image: linear-gradient(45deg, rgba(255,255,255,0.1) 25%, transparent 25%), linear-gradient(-45deg, rgba(255,255,255,0.1) 25%, transparent 25%), linear-gradient(45deg, transparent 75%, rgba(255,255,255,0.1) 75%), linear-gradient(-45deg, transparent 75%, rgba(255,255,255,0.1) 75%);
  background-size: 18px 18px; }
  .card.flipped { transform: rotateY(0deg); }
  .card-front.red { color: var(--card-text-red);
  }
  .card-front.black { color: var(--card-text-black); }
  .card .suit { font-size: 16px; font-weight: normal; line-height: 1.1;
  }

  /* --- Buttons & Betting (Usano variabili CSS) --- */
  #buttons, #betting-buttons { margin-top: 20px; display: flex;
  flex-wrap: wrap; justify-content: center; gap: 10px; }
  button, .toggle-switch label { padding: 12px 20px; font-size: 15px; font-weight: bold;
  margin: 5px; cursor: pointer; border: none; border-radius: 8px; background-color: var(--button-bg); color: var(--button-text);
  transition: background-color 0.2s ease, opacity 0.3s ease, transform 0.15s ease, box-shadow 0.2s ease; user-select: none; -webkit-user-select: none;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3); letter-spacing: 0.5px; }
  button:hover:not(:disabled) { background-color: var(--button-hover-bg); transform: translateY(-2px);
  box-shadow: 0 4px 8px rgba(0, 0, 0, 0.4); }
  button:active:not(:disabled) { transform: translateY(0px);
  box-shadow: 0 1px 2px rgba(0, 0, 0, 0.3); }
  button:disabled { opacity: var(--button-disabled-opacity); cursor: not-allowed; box-shadow: none; transform: none;
  }
  button.hint-highlight { box-shadow: 0 0 12px 4px var(--highlight-color); border: 1px solid var(--highlight-color); transform: translateY(-1px);
  }

  /* --- Betting Area with Chips (Usano variabili CSS) --- */
   #betting-area { margin-bottom: 20px;
   display: flex; flex-direction: column; align-items: center; gap: 15px; }
   #proposed-bet-display { font-size: 1.4em; font-weight: bold; color: var(--highlight-color);
   min-height: 1.5em; background-color: var(--panel-bg); padding: 5px 15px; border-radius: 5px; }
   #clickable-chips { display: flex; flex-wrap: wrap; justify-content: center;
   gap: 10px; margin-bottom: 15px; }
   .chip-button { width: 55px; height: 55px; cursor: pointer; border-radius: 50%;
   border: 3px solid rgba(255, 255, 255, 0.4); transition: transform 0.1s ease-out, opacity 0.3s ease, box-shadow 0.2s ease, border-color 0.2s ease;
   box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.5), 0 1px 2px rgba(0,0,0,0.2); user-select: none; -webkit-user-select: none; background-color: transparent;
   display: flex; justify-content: center; align-items: center; overflow: hidden; }
   .chip-button img { display: block; width: 100%; height: 100%;
   }
   .chip-button:hover:not([disabled]) { transform: scale(1.03); border-color: white; box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.5), 0 0 10px 2px var(--highlight-color);
   }
   .chip-button:active:not([disabled]) { transform: scale(0.97); box-shadow: inset 0 3px 5px rgba(0, 0, 0, 0.6);
   }
   .chip-button[disabled] { opacity: 0.4; cursor: not-allowed; transform: none; border-color: rgba(255, 255, 255, 0.4);
   box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.5); }
   #bet-chips { min-height: 30px; margin-top: 10px; font-size: 1.2em;
   font-weight: bold; color: var(--text-color); background-color: var(--panel-bg); padding: 3px 10px; border-radius: 5px;
   }

  /* --- Player/Dealer Info (Usano variabili CSS) --- */
  #player-info, #dealer-info { margin-bottom: 20px;
  }

  /* --- Multiple Hands (Usano variabili CSS) --- */
  #player-hands-container { display: flex; justify-content: center; gap: 20px;
  flex-wrap: wrap; margin-top: 15px; }
  .player-hand { border: 2px solid var(--border-color); border-radius: 12px; padding: 15px; min-width: 180px; background-color: var(--panel-bg);
  position: relative; transition: border-color 0.3s, box-shadow 0.3s; box-shadow: 0 2px 5px rgba(0,0,0,0.3); }
  .player-hand h3 { margin-top: 0;
  margin-bottom: 8px; font-size: 1.1em; color: var(--accent-color); text-align: center; }
  .player-hand .cards { min-height: 100px; margin-bottom: 10px;
  }
  .player-score { font-size: 1em; margin-bottom: 5px; margin-top: 8px; font-weight: bold; }
  .hand-status { font-size: 1em; font-weight: bold;
  color: var(--highlight-color); min-height: 1.2em; text-align: center; }
  .player-hand.current-hand { border-color: var(--highlight-color); box-shadow: 0 0 15px rgba(255, 223, 0, 0.6);
  }

  /* --- Result Message (Invariato) --- */
  #result { opacity: 0; visibility: hidden; transform: translate(-50%, -50%) scale(0.8);
  transition: opacity 0.4s ease-out, visibility 0s linear 0.4s, transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); position: fixed; top: 50%; left: 50%;
  z-index: 100; background-color: var(--result-bg-color); color: var(--result-text-color); padding: 25px 40px; border-radius: 15px; font-size: 2.8em; font-weight: bold; text-align: center; white-space: pre-line;
  min-width: 300px; max-width: 80%; box-shadow: 0 0 20px 5px rgba(0, 0, 0, 0.5); }
  #result.result-show { opacity: 1;
  visibility: visible; transform: translate(-50%, -50%) scale(1); transition: opacity 0.4s ease-out, visibility 0s linear 0s, transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
  }
  #result.win { box-shadow: 0 0 25px 10px var(--result-win-glow); }
  #result.lose { box-shadow: 0 0 25px 10px var(--result-lose-glow);
  }
  #result.push { box-shadow: 0 0 25px 10px var(--result-push-glow);
  }

  /* --- Toggle Switch (Invariato) --- */
   .toggle-switch { position: relative; display: inline-block; width: 50px;
   height: 24px; vertical-align: middle; }
   .toggle-switch input { opacity: 0; width: 0; height: 0;
   }
   .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #555;
   transition: .4s; border-radius: 24px; }
   .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 3px;
   bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
   input:checked + .slider { background-color: var(--accent-color);
   }
   input:focus + .slider { box-shadow: 0 0 2px var(--accent-color);
   }
   input:checked + .slider:before { transform: translateX(26px); }

  /* --- Visually Hidden --- */
  .visually-hidden { position: absolute;
  width: 1px; height: 1px; margin: -1px; padding: 0; overflow: hidden; clip: rect(0, 0, 0, 0); border: 0;
  }

  /* --- Responsiveness --- */
  @media (max-width: 768px) {
      .card { width: 60px;
      height: 90px; border-radius: 6px;}
      .card-front { font-size: 20px;
      }
      .card .suit { font-size: 14px;
      }
      button, .toggle-switch label { font-size: 14px;
      padding: 10px 15px;}
      #hilo-info-button { width: 22px; height: 22px; font-size: 14px; line-height: 20px;
      }
      .player-hand { min-width: 160px; padding: 12px;
      border-radius: 10px;}
      h1 { font-size: 2em;
      }
      details { max-width: 90%; padding: 0;
      } /* Adattato per details */
      details .content-wrapper { padding: 12px;
      } /* Adattato per details */
      .chip-button { width: 50px; height: 50px; border-width: 2px;
      }
      #result { font-size: 2.2em; padding: 20px 30px;
      }
  }

   @media (max-width: 480px) {
      body { padding-top: 10px;
      }
      .game-container { padding: 10px; }
      h1 { font-size: 1.6em;
      }
      .cards { min-height: 100px;
      gap: 8px;}
      .card { width: 50px; height: 75px; border-radius: 4px;
      margin: 2px;}
      .card-front { font-size: 16px;
      }
      .card .suit { font-size: 12px;
      }
      #buttons, #betting-buttons { margin-top: 15px;
      gap: 5px;}
      button, .toggle-switch label { font-size: 12px; padding: 8px 10px;
      margin: 3px;}
      #hilo-info-button { width: 20px; height: 20px; font-size: 12px; line-height: 18px;
      margin-left: 5px;}
      .player-hand { min-width: 130px; padding: 8px; gap: 8px;
      border-radius: 8px;}
      .player-hand .cards { min-height: 80px;
      }
      #player-hands-container { gap: 10px; }
      #result { font-size: 1.6em;
      padding: 15px 20px; min-width: 250px;}
      details { padding: 0; margin: 10px auto; font-size: 0.9em;
      } /* Adattato per details */
      details .content-wrapper { padding: 10px;
      } /* Adattato per details */
      #utility-controls-content div, #stats-content div, #trainer-controls-content div { flex-direction: row;
      align-items: center; }
      .chip-button { width: 45px; height: 45px; gap: 5px;
      border-width: 2px;}
      #proposed-bet-display { font-size: 1.2em; padding: 4px 10px;
      }
   }
</style>
</head>
<body>
<div class="game-container">
    <h1>Blackjack Trainer</h1>

    <details id="utility-controls">
        <summary>Utilità e Opzioni</summary>
        <div class="content-wrapper" id="utility-controls-content">
            <div>
                <label for="theme-toggle">Tema Scuro</label>
                <label class="toggle-switch">
                     <input type="checkbox" id="theme-toggle">
                    <span class="slider"></span>
                </label>
            </div>
            <div>
                 <label for="training-mode-toggle">Modalità Allenamento Conteggio</label>
                 <label class="toggle-switch">
                     <input type="checkbox" id="training-mode-toggle">
                     <span class="slider"></span>
                 </label>
            </div>
             <div>
                 <label for="show-hints-toggle">Mostra Suggerimenti (Console)</label>
                 <label class="toggle-switch">
                     <input type="checkbox" id="show-hints-toggle">
                     <span class="slider"></span>
                 </label>
             </div>
             <div style="margin-top: 15px; text-align: center;">
<button id="change-game-button" onclick="changeGame()">Cambia Gioco</button>
             </div>
        </div>
    </details>

    <details id="trainer-controls">
        <summary>Contatore Carte (Hi-Lo)</summary>
         <div class="content-wrapper" id="trainer-controls-content">
<h3 id="trainer-title">
                 Contatore Carte (Hi-Lo)
                 <button id="hilo-info-button" onclick="showHiLoInfo()" aria-label="Informazioni sul conteggio Hi-Lo" title="Cos'è il conteggio Hi-Lo?">?</button>
             </h3>
             <div><span>Conteggio Corrente (Running Count):</span> <span id="running-count">0</span></div>
             <div><span>Mazzi Rimanenti (stimati):</span> <span id="decks-remaining">0.0</span></div>
<div><span>Conteggio Reale (True Count):</span> <span id="true-count">0.0</span></div>
         </div>
    </details>


    <details id="session-stats">
        <summary>Statistiche Sessione</summary>
        <div class="content-wrapper" id="stats-content">
            <h3>Statistiche Sessione</h3>
            <div><span>Mani Giocate:</span> <span id="stats-hands">0</span></div>
            <div><span>Vittorie:</span> <span id="stats-wins">0</span></div>
            <div><span>Sconfitte:</span> <span id="stats-losses">0</span></div>
 <div><span>Pareggi:</span> <span id="stats-pushes">0</span></div>
            <div><span>Blackjack Vinti:</span> <span id="stats-bjs">0</span></div>
            <div><span>Win Rate (V/V+S):</span> <span id="stats-win-rate">N/A</span></div>
            <button id="reset-stats-button" onclick="resetStats()">Azzera Statistiche</button>
        </div>
    </details>


    <div id="player-info">
     <h2>Giocatore</h2>
     <p id="player-balance">Saldo: $1000</p>
     <div id="bet-chips">Puntata Mano: $0</div>
<div id="player-hands-container">
     </div>
    </div>

    <div id="dealer-info">
     <h2>Banco</h2>
     <div id="dealer-cards" class="cards" aria-label="Carte del banco"></div>
     <p id="dealer-score">Punteggio: ???</p>
    </div>

    <div id="betting-area">
        <h3>Piazza la tua Puntata</h3>
        <div id="proposed-bet-display">Puntata: $0</div>

        <div id="clickable-chips">
<img src="data:image/svg+xml;charset=utf-8,%3Csvg width='50' height='50' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Ccircle cx='50' cy='50' r='48' fill='%23FFFFFF' stroke='%23000000' stroke-width='2'/%3E%3Ctext x='50' y='55' font-family='sans-serif' font-size='40' font-weight='bold' fill='%23000000' text-anchor='middle' dominant-baseline='middle'%3E10%3C/text%3E%3C/svg%3E" alt="Fiche da $10" class="chip-button" data-value="10" width="55" height="55" draggable="false">
            <img src="data:image/svg+xml;charset=utf-8,%3Csvg width='50' height='50' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Ccircle cx='50' cy='50' r='48' fill='%23888888' stroke='%23000000' stroke-width='2'/%3E%3Ctext x='50' y='55' font-family='sans-serif' font-size='40' font-weight='bold' fill='%23FFFFFF' text-anchor='middle' dominant-baseline='middle'%3E20%3C/text%3E%3C/svg%3E" alt="Fiche da $20" class="chip-button" data-value="20" width="55" height="55" draggable="false">
            <img src="data:image/svg+xml;charset=utf-8,%3Csvg width='50' height='50' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Ccircle cx='50' cy='50' r='48' fill='%23FF0000' stroke='%23000000' stroke-width='2'/%3E%3Ctext x='50' y='55' font-family='sans-serif' font-size='40' font-weight='bold' fill='%23FFFFFF' text-anchor='middle' dominant-baseline='middle'%3E50%3C/text%3E%3C/svg%3E" alt="Fiche da $50" class="chip-button" data-value="50" width="55" height="55" draggable="false">
<img src="data:image/svg+xml;charset=utf-8,%3Csvg width='50' height='50' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Ccircle cx='50' cy='50' r='48' fill='%23000000' stroke='%23FFFFFF' stroke-width='2'/%3E%3Ctext x='50' y='55' font-family='sans-serif' font-size='35' font-weight='bold' fill='%23FFFFFF' text-anchor='middle' dominant-baseline='middle'%3E100%3C/text%3E%3C/svg%3E" alt="Fiche da $100" class="chip-button" data-value="100" width="55" height="55" draggable="false">
            <img src="data:image/svg+xml;charset=utf-8,%3Csvg width='50' height='50' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Ccircle cx='50' cy='50' r='48' fill='%23800080' stroke='%23FFFFFF' stroke-width='2'/%3E%3Ctext x='50' y='55' font-family='sans-serif' font-size='35' font-weight='bold' fill='%23FFFFFF' text-anchor='middle' dominant-baseline='middle'%3E500%3C/text%3E%3C/svg%3E" alt="Fiche da $500" class="chip-button" data-value="500" width="55" height="55" draggable="false">
<img src="data:image/svg+xml;charset=utf-8,%3Csvg width='50' height='50' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Ccircle cx='50' cy='50' r='48' fill='%23FFA500' stroke='%23000000' stroke-width='2'/%3E%3Ctext x='50' y='55' font-family='sans-serif' font-size='30' font-weight='bold' fill='%23000000' text-anchor='middle' dominant-baseline='middle'%3E1000%3C/text%3E%3C/svg%3E" alt="Fiche da $1000" class="chip-button" data-value="1000" width="55" height="55" draggable="false">
            <img src="data:image/svg+xml;charset=utf-8,%3Csvg width='50' height='50' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Ccircle cx='50' cy='50' r='48' fill='%230000FF' stroke='%23FFFFFF' stroke-width='2'/%3E%3Ctext x='50' y='55' font-family='sans-serif' font-size='30' font-weight='bold' fill='%23FFFFFF' text-anchor='middle' dominant-baseline='middle'%3E2000%3C/text%3E%3C/svg%3E" alt="Fiche da $2000" class="chip-button" data-value="2000" width="55" height="55" draggable="false">
        </div>
        <div id="betting-buttons">
         <button id="place-bet-button" onclick="placeBet()" disabled aria-label="Piazza la puntata selezionata">Conferma Puntata</button>
 <button id="clear-bet-button" onclick="clearProposedBet()" disabled aria-label="Azzera la puntata selezionata">Azzera Puntata</button>
         <button id="all-in-button" onclick="playerAllIn()" disabled aria-label="Punta tutto il saldo disponibile">All-in</button>
         <button id="restore-bet-button" onclick="restoreBet()" disabled aria-label="Ripristina l'ultima puntata piazzata">Ripristina Puntata</button>
        </div>
    </div>
    <div id="buttons">
     <button id="hit-button" onclick="playerHit()" disabled aria-label="Chiedi un'altra carta (H)">Carta (H)</button>
     <button id="stand-button" onclick="playerStand()" disabled aria-label="Stai con le carte attuali (Spazio/S)">Stai (Spazio/S)</button>
<button id="double-down-button" onclick="playerDoubleDown()" disabled aria-label="Raddoppia la puntata e prendi una sola carta (D)">Raddoppia (D)</button>
     <button id="surrender-button" onclick="playerSurrender()" disabled aria-label="Arrenditi e recupera metà puntata (R)">Resa (R)</button>
     <button id="split-button" onclick="playerSplit()" disabled aria-label="Dividi le carte (L)">Dividi (L)</button>
     <button id="new-game-button" onclick="resetGame(true)" disabled aria-label="Inizia una nuova partita (N)">Nuova Partita (N)</button>
    </div>

    <div id="result" aria-live="polite"></div>

</div>

<script>
    // --- Constants and Global Variables (Invariati) ---
    const suits = ['♥', '♦', '♣', '♠'];
    const ranks = ['2', '3', '4', '5', '6', '7', '8', '9', '10', 'J', 'Q', 'K', 'A']; // [cite: 445]
    const numDecks = 6;
    const localStorageKey = 'blackjackBalance'; // [cite: 446]
    const lastBetStorageKey = 'blackjackLastBet'; // [cite: 446]
    const statsStorageKey = 'blackjackStats'; // [cite: 446]
    const themeStorageKey = 'blackjackTheme'; // [cite: 446]
    const utilityOpenKey = 'blackjackUtilityOpen'; // [cite: 446]
    const statsOpenKey = 'blackjackStatsOpen'; // [cite: 447]
    const trainerOpenKey = 'blackjackTrainerOpen'; // [cite: 447]


    let deck = [];
    let playerHands = [];
    let dealerHand = [];
    let gameOver = true; // [cite: 448]
    let playerBalance = 1000; // [cite: 448]
    let currentBet = 0;
    let baseBet = 0;
    let lastBet = 10;
    let proposedBet = 0; // [cite: 449]
    let currentPlayerHandIndex = 0;
    let resultPopupTimeoutId = null;
    let runningCount = 0;
    let trueCount = 0;
    let isTrainingMode = false; // [cite: 450]
    let showHints = false; // [cite: 450]
    let initialDeckSize = numDecks * 52;
    let stats = { handsPlayed: 0, wins: 0, losses: 0, pushes: 0, blackjacks: 0 }; // [cite: 451]
    // --- DOM Elements ---
    const hitButton = document.getElementById('hit-button'); // [cite: 452]
    const standButton = document.getElementById('stand-button'); // [cite: 452]
    const doubleDownButton = document.getElementById('double-down-button'); // [cite: 452]
    const surrenderButton = document.getElementById('surrender-button'); // [cite: 453]
    const splitButton = document.getElementById('split-button'); // [cite: 453]
    const placeBetButton = document.getElementById('place-bet-button'); // [cite: 453]
    const clearBetButton = document.getElementById('clear-bet-button'); // [cite: 453]
    const allInButton = document.getElementById('all-in-button'); // [cite: 453]
    const restoreBetButton = document.getElementById('restore-bet-button'); // [cite: 454]
    const newGameButton = document.getElementById('new-game-button'); // [cite: 454]
    const changeGameButton = document.getElementById('change-game-button'); // [cite: 454]
    // New Button
    const resultElement = document.getElementById('result'); // [cite: 455]
    const playerBalanceElement = document.getElementById('player-balance'); // [cite: 455]
    const playerHandsContainer = document.getElementById('player-hands-container'); // [cite: 455]
    const dealerCardsContainer = document.getElementById('dealer-cards'); // [cite: 456]
    const dealerScoreElement = document.getElementById('dealer-score'); // [cite: 456]
    const clickableChipsContainer = document.getElementById('clickable-chips'); // [cite: 456]
    const proposedBetDisplay = document.getElementById('proposed-bet-display'); // [cite: 456]
    const betChipsContainer = document.getElementById('bet-chips'); // [cite: 456]
    const utilityControls = document.getElementById('utility-controls'); // Details element [cite: 457]
    const trainerControls = document.getElementById('trainer-controls'); // [cite: 457]
    // Details element
    const sessionStats = document.getElementById('session-stats');     // Details element [cite: 458]
    const runningCountDisplay = document.getElementById('running-count'); // [cite: 458]
    const trueCountDisplay = document.getElementById('true-count'); // [cite: 459]
    const decksRemainingDisplay = document.getElementById('decks-remaining'); // [cite: 459]
    const statsHandsDisplay = document.getElementById('stats-hands'); // [cite: 459]
    const statsWinsDisplay = document.getElementById('stats-wins'); // [cite: 459]
    const statsLossesDisplay = document.getElementById('stats-losses'); // [cite: 459]
    const statsPushesDisplay = document.getElementById('stats-pushes'); // [cite: 460]
    const statsBjsDisplay = document.getElementById('stats-bjs'); // [cite: 460]
    const statsWinRateDisplay = document.getElementById('stats-win-rate'); // [cite: 460]
    const themeToggle = document.getElementById('theme-toggle'); // [cite: 460]
    const trainingModeToggle = document.getElementById('training-mode-toggle'); // [cite: 460]
    const showHintsToggle = document.getElementById('show-hints-toggle'); // [cite: 461]

    // --- Sound Function (Invariata) ---
    function playSound(soundElement) { /* ... */ } // [cite: 461]

    // --- Persistence Functions (Aggiornato per stato <details>) ---
    function saveGameState() { // [cite: 461]
        try {
            localStorage.setItem(localStorageKey, playerBalance.toString()); // [cite: 462]
            if (typeof lastBet === 'number' && lastBet > 0) { // [cite: 462]
                 localStorage.setItem(lastBetStorageKey, lastBet.toString()); // [cite: 462]
            } else { // [cite: 463]
                 localStorage.removeItem(lastBetStorageKey); // [cite: 463]
            }
            localStorage.setItem(statsStorageKey, JSON.stringify(stats)); // [cite: 464]
            localStorage.setItem(themeStorageKey, document.body.dataset.theme || 'light'); // [cite: 464]
            // Salva stato <details>
            localStorage.setItem(utilityOpenKey, utilityControls.open); // [cite: 465]
            localStorage.setItem(statsOpenKey, sessionStats.open); // [cite: 465]
            localStorage.setItem(trainerOpenKey, trainerControls.open); // [cite: 466]

        } catch (e) { console.error("Errore saveGameState:", e); } // [cite: 466]
    }

    function loadGameState() { // [cite: 466]
        try {
            const savedBalance = localStorage.getItem(localStorageKey); // [cite: 467]
            playerBalance = (savedBalance !== null && !isNaN(parseInt(savedBalance)) && parseInt(savedBalance) >= 0) ? parseInt(savedBalance) : 1000; // [cite: 467]
            const savedLastBet = localStorage.getItem(lastBetStorageKey); // [cite: 467]
            lastBet = (savedLastBet !== null && !isNaN(parseInt(savedLastBet)) && parseInt(savedLastBet) > 0) ? parseInt(savedLastBet) : 10; // [cite: 468]
        } catch (e) { console.error("Errore caricamento balance/lastBet:", e); playerBalance = 1000; lastBet = 10; // [cite: 469]
        }
        if (lastBet < 1) lastBet = 10; // [cite: 470]
        try { // [cite: 471]
            const savedStats = localStorage.getItem(statsStorageKey); // [cite: 471]
            if (savedStats) { // [cite: 472]
                const parsedStats = JSON.parse(savedStats); // [cite: 472]
                stats.handsPlayed = Number(parsedStats.handsPlayed) || 0; // [cite: 473]
                stats.wins = Number(parsedStats.wins) || 0; // [cite: 473]
                stats.losses = Number(parsedStats.losses) || 0; // [cite: 473]
                stats.pushes = Number(parsedStats.pushes) || 0; // [cite: 473]
                stats.blackjacks = Number(parsedStats.blackjacks) || 0; // [cite: 474]
            } else { resetStats(false); } // [cite: 474]
        } catch (e) { console.error("Errore caricamento stats:", e); // [cite: 474]
            resetStats(false); } // [cite: 475]

        const savedTheme = localStorage.getItem(themeStorageKey) || 'light'; // [cite: 475]
        document.body.dataset.theme = savedTheme; // [cite: 475]
        themeToggle.checked = (savedTheme === 'dark'); // [cite: 476]

        // Carica stato <details>
        utilityControls.open = localStorage.getItem(utilityOpenKey) === 'true'; // [cite: 476]
        sessionStats.open = localStorage.getItem(statsOpenKey) === 'true'; // [cite: 477]
        trainerControls.open = localStorage.getItem(trainerOpenKey) === 'true'; // [cite: 477]


        updateStatsDisplay(); // [cite: 477]
        updateUI(); // [cite: 477]
    }

    // --- Deck Functions (Invariati) ---
    function createCard(suit, rank) { return { suit, rank, value: getCardValue(rank), hiLoValue: getHiLoValue(rank), revealed: false }; // [cite: 478]
    }
    function createDeck() { deck = []; // [cite: 479]
        for (let i = 0; i < numDecks; i++) { for (const suit of suits) { for (const rank of ranks) { deck.push(createCard(suit, rank)); // [cite: 480]
        } } } initialDeckSize = deck.length; runningCount = 0; trueCount = 0; // [cite: 481]
    }
    function shuffleDeck() { for (let i = deck.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); // [cite: 482]
        [deck[i], deck[j]] = [deck[j], deck[i]]; } } // [cite: 483]
    function dealCard(reveal = true) { if (deck.length < initialDeckSize * 0.25) { console.log("--- Mazzo rimescolato ---"); // [cite: 483]
        createDeck(); shuffleDeck(); } if (deck.length === 0) { console.error("Mazzo finito!"); return null; } const card = deck.pop(); card.revealed = reveal; // [cite: 484]
        if (reveal) { updateRunningCount(card); } return card; } // [cite: 485]

    // --- Card Value and Hi-Lo Functions (Invariati) ---
    function getCardValue(rank) { if (['K', 'Q', 'J', '10'].includes(rank)) { return 10; // [cite: 485]
        } else if (rank === 'A') { return 11; } else { return parseInt(rank); // [cite: 486]
        } }
    function getHiLoValue(rank) { const value = getCardValue(rank); // [cite: 487]
        if (value >= 2 && value <= 6) return 1; // [cite: 488]
        if (value === 10 || value === 11 || rank === 'A') return -1; return 0; // [cite: 489]
    }
    function updateRunningCount(card) { if (!card || !card.revealed) return; runningCount += card.hiLoValue; updateTrueCount(); updateTrainerDisplay(); // [cite: 490]
    }
    function updateTrueCount() { const decksRemaining = Math.max(0.5, Math.round((deck.length / 52) * 2) / 2); // [cite: 491]
        trueCount = decksRemaining > 0 ? runningCount / decksRemaining : 0; // [cite: 492]
    }

    // --- Hand Calculation (Invariato) ---
    function calculateHandValue(hand) { let value = 0; // [cite: 493]
        let aceCount = 0; for (const card of hand) { if(card.revealed) { value += card.value; // [cite: 494]
        if (card.rank === 'A') { aceCount++; } } } while (value > 21 && aceCount > 0) { value -= 10; // [cite: 495]
        aceCount--; } return value; } // [cite: 496]

    // --- Display Functions (Invariato) ---
    function displayCard(card, container, hidden = false) { const cardElement = document.createElement('div'); // [cite: 496]
        cardElement.classList.add('card'); const cardInner = document.createElement('div'); cardInner.classList.add('card-inner'); const cardFront = document.createElement('div'); cardFront.classList.add('card-face', 'card-front'); const rankSpan = document.createElement('span'); rankSpan.textContent = card.rank; // [cite: 497]
        const suitSpan = document.createElement('span'); suitSpan.classList.add('suit'); suitSpan.textContent = card.suit; if (['♥', '♦'].includes(card.suit)) { cardFront.classList.add('red'); } else { cardFront.classList.add('black'); } cardFront.appendChild(rankSpan); cardFront.appendChild(suitSpan); // [cite: 498]
        const cardBack = document.createElement('div'); cardBack.classList.add('card-face', 'card-back'); cardInner.appendChild(cardFront); cardInner.appendChild(cardBack); cardElement.appendChild(cardInner); setTimeout(() => { if (!hidden && card.revealed) { cardElement.classList.add('flipped'); } }, 50 + Math.random() * 100); // [cite: 499]
        container.appendChild(cardElement); } // [cite: 500]

    // --- Game Flow Functions (Invariati - Logica Puntate Sembra OK) ---
    function resetGame(isNewGameButton = false) { // [cite: 500]
        clearTimeout(resultPopupTimeoutId);
        gameOver = true; // [cite: 501]
        resultElement.textContent = '';
        resultElement.className = 'result';

        if (playerBalance <= 0) { // [cite: 501]
            console.log("Saldo a zero o negativo, ripristino a $1000.");
            playerBalance = 1000; // [cite: 502]
            alert("Saldo esaurito! Il tuo saldo è stato ripristinato a $1000.");
            saveGameState(); // [cite: 502]
        }

        playerHands = []; dealerHand = []; currentPlayerHandIndex = 0; // [cite: 503]
        playerHandsContainer.innerHTML = ''; // [cite: 503]
        dealerCardsContainer.innerHTML = ''; // [cite: 504]
        dealerScoreElement.textContent = 'Punteggio: ???'; betChipsContainer.textContent = 'Puntata Mano: $0'; // [cite: 504]
        if (isNewGameButton || deck.length < initialDeckSize * 0.25) { createDeck(); shuffleDeck(); console.log("Nuovo mazzo creato e mescolato."); // [cite: 505]
        }
        else { updateTrueCount(); // [cite: 506]
        }

        proposedBet = 0; updateUI(); updateTrainerDisplay(); // [cite: 507]
        enableBettingControls(true); updateActionButtons(); // [cite: 507]
    }
    function placeBet() { // [cite: 508]
        // Logica sembra corretta: verifica puntata, aggiorna stato, distribuisce carte
        if (proposedBet <= 0 || proposedBet > playerBalance) { alert("Puntata non valida."); // [cite: 508]
            return; } // [cite: 509]
        clearTimeout(resultPopupTimeoutId); resultElement.classList.remove('result-show'); // [cite: 509]
        currentBet = proposedBet; baseBet = proposedBet; lastBet = proposedBet; // [cite: 509]
        playerBalance -= currentBet; gameOver = false; // [cite: 510]
        saveGameState(); enableBettingControls(false); dealInitialHands(); // [cite: 510]
    }
    function dealInitialHands() { // [cite: 510]
        playerHands = [{ id: 0, cards: [], bet: currentBet, outcome: null, message: "", status: 'active', isDoubled: false, fromSplitAces: false }]; // [cite: 510]
        dealerHand = []; // [cite: 511]
        playerHands[0].cards.push(dealCard()); dealerHand.push(dealCard()); // [cite: 511]
        playerHands[0].cards.push(dealCard()); dealerHand.push(dealCard(false)); // [cite: 511]
        currentPlayerHandIndex = 0; updateUI(); // [cite: 511]
        const playerValue = calculateHandValue(playerHands[0].cards); // [cite: 511]
        if (playerValue === 21) { // [cite: 512]
            revealDealerCard(); // [cite: 512]
            const finalDealerValue = calculateHandValue(dealerHand); // [cite: 513]
            if (finalDealerValue === 21) { playerHands[0].outcome = 'push'; playerHands[0].message = 'Push! (Entrambi Blackjack)'; playerHands[0].status = 'push'; // [cite: 513]
                playerBalance += playerHands[0].bet; stats.pushes++; } // [cite: 514]
            else { playerHands[0].outcome = 'blackjack'; // [cite: 514]
                playerHands[0].message = 'Blackjack!'; playerHands[0].status = 'blackjack'; playerBalance += playerHands[0].bet * 2.5; stats.blackjacks++; stats.wins++; // [cite: 515]
            }
            gameOver = true; stats.handsPlayed++; saveGameState(); updateUI(); showResult(playerHands[0].message, playerHands[0].outcome); // [cite: 516]
        } else { updateActionButtons(); if (showHints) provideHint(); } // [cite: 517]
    }

    // --- Player Actions (Invariati) ---
    function playerHit() { // [cite: 517]
        if (gameOver || playerHands.length === 0 || playerHands[currentPlayerHandIndex].status !== 'active') return;
        const currentHand = playerHands[currentPlayerHandIndex]; currentHand.cards.push(dealCard()); updateUI(); // [cite: 518]
        const handValue = calculateHandValue(currentHand.cards); // [cite: 518]
        if (handValue > 21) { currentHand.status = 'busted'; // [cite: 518]
            currentHand.outcome = 'lose'; currentHand.message = 'Sballato!'; stats.losses++; stats.handsPlayed++; saveGameState(); moveToNextHandOrDealer(); // [cite: 519]
        }
        else if (handValue === 21) { console.log(`Mano ${currentHand.id + 1}: Raggiunto 21, auto-stand.`); // [cite: 520]
            currentHand.status = 'stand'; currentHand.message = '21!'; saveGameState(); moveToNextHandOrDealer(); } // [cite: 521]
        else { updateActionButtons(); // [cite: 521]
            if (showHints) provideHint(); } // [cite: 522]
    }
    function playerStand() { if (gameOver || playerHands.length === 0 || playerHands[currentPlayerHandIndex].status !== 'active') return; // [cite: 522]
        const currentHand = playerHands[currentPlayerHandIndex]; currentHand.status = 'stand'; currentHand.message = 'Stai'; moveToNextHandOrDealer(); // [cite: 523]
    }
    function playerDoubleDown() { if (gameOver || playerHands.length === 0 || playerHands[currentPlayerHandIndex].status !== 'active') return; // [cite: 524]
        const currentHand = playerHands[currentPlayerHandIndex]; if (currentHand.cards.length !== 2 || playerBalance < currentHand.bet) { console.warn("Non puoi raddoppiare ora."); return; // [cite: 525]
        } playerBalance -= currentHand.bet; currentHand.bet *= 2; currentHand.isDoubled = true; const card = dealCard(); currentHand.cards.push(card); updateUI(); const handValue = calculateHandValue(currentHand.cards); // [cite: 526]
        if (handValue > 21) { currentHand.status = 'busted'; currentHand.outcome = 'lose'; currentHand.message = `Sballato (${handValue})`; stats.losses++; // [cite: 527]
        } else { currentHand.status = 'stand'; currentHand.message = `Stai (${handValue})`; } stats.handsPlayed++; saveGameState(); moveToNextHandOrDealer(); // [cite: 528]
    }
    function playerSurrender() { if (gameOver || playerHands.length === 0 || playerHands[currentPlayerHandIndex].status !== 'active') return; // [cite: 529]
        const currentHand = playerHands[currentPlayerHandIndex]; if (currentHand.cards.length !== 2 || playerHands.length > 1) { console.warn("Non puoi arrenderti ora."); return; // [cite: 530]
        } currentHand.status = 'surrender'; currentHand.outcome = 'surrender'; currentHand.message = 'Resa'; playerBalance += currentHand.bet / 2; stats.losses++; stats.handsPlayed++; gameOver = true; // [cite: 531]
        saveGameState(); updateUI(); showResult("Hai scelto la Resa!", 'lose'); enableBettingControls(false); updateActionButtons(); } // [cite: 532]
    function playerSplit() { if (gameOver || playerHands.length === 0 || playerHands[currentPlayerHandIndex].status !== 'active') return; // [cite: 532]
        const currentHand = playerHands[currentPlayerHandIndex]; if (currentHand.cards.length !== 2 || getCardValue(currentHand.cards[0].rank) !== getCardValue(currentHand.cards[1].rank) || playerBalance < currentHand.bet) { console.warn("Split non possibile"); // [cite: 533]
            return; } playerBalance -= currentHand.bet; const secondCard = currentHand.cards.pop(); const newHand = { id: playerHands.length, cards: [secondCard], bet: currentHand.bet, outcome: null, message: "", status: 'active', isDoubled: false, fromSplitAces: currentHand.cards[0].rank === 'A' }; // [cite: 534]
        currentHand.fromSplitAces = currentHand.cards[0].rank === 'A'; playerHands.splice(currentPlayerHandIndex + 1, 0, newHand); currentHand.cards.push(dealCard()); newHand.cards.push(dealCard()); if (currentHand.fromSplitAces) { currentHand.status = 'stand'; // [cite: 535]
            currentHand.message = calculateHandValue(currentHand.cards) === 21 ? '21 (Asso split)' : `Stai (${calculateHandValue(currentHand.cards)})`; newHand.status = 'stand'; // [cite: 536]
            newHand.message = calculateHandValue(newHand.cards) === 21 ? '21 (Asso split)' : `Stai (${calculateHandValue(newHand.cards)})`; if (playerHands.every(hand => hand.status !== 'active')) { revealDealerCard(); // [cite: 537]
            dealerTurn(); } else { moveToNextHandOrDealer(); } } saveGameState(); updateUI(); if (showHints && !currentHand.fromSplitAces) provideHint(); // [cite: 538]
    }
    function moveToNextHandOrDealer() { currentPlayerHandIndex++; if (currentPlayerHandIndex < playerHands.length) { updateUI(); // [cite: 539]
        if (playerHands[currentPlayerHandIndex].status === 'stand' || playerHands[currentPlayerHandIndex].status === 'busted') { moveToNextHandOrDealer(); } else { updateActionButtons(); if (showHints) provideHint(); // [cite: 540]
        } } else { revealDealerCard(); dealerTurn(); } } // [cite: 541]

    // --- Dealer Logic (Invariati) ---
    function revealDealerCard() { const hiddenCard = dealerHand.find(card => !card.revealed); // [cite: 541]
        if (hiddenCard) { hiddenCard.revealed = true; updateRunningCount(hiddenCard); updateUI(); } } // [cite: 542]
    function dealerTurn() { if (gameOver || playerHands.every(hand => hand.status === 'busted' || hand.status === 'surrender')) { gameOver = true; // [cite: 542]
        determineWinner(); return; } disableActionButtons(); function dealerAction() { let dealerValue = calculateHandValue(dealerHand); updateUI(); if (dealerValue < 17) { console.log("Banco prende carta..."); // [cite: 543]
        dealerHand.push(dealCard()); revealDealerCard(); setTimeout(dealerAction, 800); } else { console.log("Banco sta."); gameOver = true; determineWinner(); } } setTimeout(dealerAction, 500); // [cite: 544]
    }

    // --- Determine Winner (Invariati) ---
    function determineWinner() { const dealerValue = calculateHandValue(dealerHand); // [cite: 545]
        let finalMessage = ""; let handsStillInPlay = false; playerHands.forEach(hand => { if (hand.outcome || hand.status === 'busted' || hand.status === 'surrender') { if(hand.status === 'busted' && !hand.outcome) hand.outcome = 'lose'; if(hand.status === 'surrender' && !hand.outcome) hand.outcome = 'lose'; return; } handsStillInPlay = true; const playerValue = calculateHandValue(hand.cards); if (dealerValue > 21) { hand.outcome = 'win'; hand.message = `Vinto! (Banco sballa: ${dealerValue})`; playerBalance += hand.bet * 2; stats.wins++; } else if (playerValue > dealerValue) { hand.outcome = 'win'; hand.message = `Vinto! (${playerValue} vs ${dealerValue})`; playerBalance += hand.bet * 2; stats.wins++; } else if (playerValue < dealerValue) { hand.outcome = 'lose'; hand.message  // [cite: 546]
= `Perso. (${playerValue} vs ${dealerValue})`; stats.losses++; } else { hand.outcome = 'push'; hand.message = `Push! (${playerValue} vs ${dealerValue})`; playerBalance += hand.bet; stats.pushes++; } stats.handsPlayed++; }); // [cite: 547]
        if (!handsStillInPlay && playerHands.length > 0) { finalMessage = "Tutte le mani hanno perso prima del turno del banco."; // [cite: 548]
        } else if (playerHands.length > 0) { finalMessage = playerHands.map(h => `Mano ${h.id + 1}: ${h.message || 'Errore?'}`).join('\n'); // [cite: 549]
            const totalWin = playerHands.filter(h=>h.outcome === 'win' || h.outcome === 'blackjack').length; const totalLoss = playerHands.filter(h=>h.outcome === 'lose' || h.outcome === 'surrender').length; // [cite: 550]
            const totalPush = playerHands.filter(h=>h.outcome === 'push').length; if (playerHands.length > 1) { finalMessage += `\n---\nRiepilogo: ${totalWin} Vinte, ${totalLoss} Perse, ${totalPush} Pareggi`; // [cite: 551]
            } } else { finalMessage = "Errore: Nessuna mano giocatore trovata."; } gameOver = true; saveGameState(); updateUI(); showResult(finalMessage, determineOverallOutcome()); // [cite: 552]
    }
    function determineOverallOutcome() { if (playerHands.length === 0) return 'push'; // [cite: 553]
        const wins = playerHands.some(h => h.outcome === 'win' || h.outcome === 'blackjack'); // [cite: 554]
        const losses = playerHands.some(h => h.outcome === 'lose' || h.outcome === 'surrender' || h.status === 'busted'); // [cite: 555]
        if (wins && !losses) return 'win'; if (losses && !wins) return 'lose'; return 'push'; // [cite: 556]
    }

    // --- UI Update Functions (Leggermente modificato per trainer) ---
    function updateUI() { // [cite: 557]
        playerBalanceElement.textContent = `Saldo: $${playerBalance}`; // [cite: 557]
        const activeHand = playerHands.find(h => h.status === 'active'); // [cite: 558]
        betChipsContainer.textContent = `Puntata Mano: $${activeHand ? // [cite: 558]
        activeHand.bet : (playerHands.length > 0 ? playerHands[0].bet : currentBet)}`; // [cite: 559]
        playerHandsContainer.innerHTML = ''; // [cite: 559]
        playerHands.forEach((hand, index) => { const handDiv = document.createElement('div'); handDiv.classList.add('player-hand'); if (index === currentPlayerHandIndex && !gameOver && hand.status === 'active') { handDiv.classList.add('current-hand'); } handDiv.dataset.handId = hand.id; const title = document.createElement('h3'); title.textContent = `Mano ${hand.id + 1}`; handDiv.appendChild(title); const cardsDiv = document.createElement('div'); cardsDiv.classList.add('cards'); hand.cards.forEach(card => displayCard(card, cardsDiv, !card.revealed)); handDiv.appendChild(cardsDiv); const scoreP = document.createElement('p'); scoreP.classList.add('player-score'); scoreP.textContent = `Punteggio: ${calculateHandValue(hand.cards)}`; handDiv.appendChild(scoreP); const statusP = document.createElement('p'); statusP.classList.add('hand-status'); statusP.textContent = hand.message || (hand.status === 'active' ? 'Attiva' : hand.status.charAt(0).toUpperCase() + hand.status.slice(1)); handDiv.appendChild(statusP); // [cite: 560]
        const betP = document.createElement('p'); betP.textContent = `Puntata: $${hand.bet}`; handDiv.appendChild(betP); playerHandsContainer.appendChild(handDiv); }); // [cite: 561]
        dealerCardsContainer.innerHTML = ''; // [cite: 561]
        dealerHand.forEach((card, index) => { let hideDealerCard = (index === 1 && !gameOver && playerHands.length > 0 && playerHands[0].status !== 'blackjack' && playerHands[0].status !== 'surrender' && !playerHands.every(h => h.status !== 'active') ); if (playerHands.every(h => h.status === 'busted') && index === 1) { hideDealerCard = false; if (!card.revealed) { revealDealerCard(); } } if((playerHands.length > 0 && (playerHands[0].status === 'blackjack' || playerHands[0].status === 'surrender')) && index === 1) { hideDealerCard = false; } displayCard(card, dealerCardsContainer, hideDealerCard); }); // [cite: 562]
        const dealerScoreVisible = dealerHand.length > 1 && dealerHand[1].revealed; dealerScoreElement.textContent = dealerScoreVisible ? `Punteggio: ${calculateHandValue(dealerHand)}` : 'Punteggio: ???'; // [cite: 563]
        updateActionButtons(); updateBettingUI(); updateTrainerDisplay(); // [cite: 563]
        updateStatsDisplay(); // [cite: 564]
    }
    function updateActionButtons() { const handExists = playerHands.length > 0 && currentPlayerHandIndex < playerHands.length; // [cite: 564]
        const currentHand = handExists ? playerHands[currentPlayerHandIndex] : null; const isActiveHand = handExists && currentHand.status === 'active'; hitButton.disabled = gameOver || // [cite: 565]
        !isActiveHand; standButton.disabled = gameOver || !isActiveHand; doubleDownButton.disabled = gameOver || !isActiveHand || currentHand.cards.length !== 2 || playerBalance < currentHand.bet || // [cite: 566]
        currentHand.fromSplitAces; surrenderButton.disabled = gameOver || !isActiveHand || currentHand.cards.length !== 2 || playerHands.length > 1; // [cite: 567]
        const canSplit = isActiveHand && currentHand.cards.length === 2 && getCardValue(currentHand.cards[0].rank) === getCardValue(currentHand.cards[1].rank) && playerBalance >= currentHand.bet; splitButton.disabled = gameOver || // [cite: 568]
        !canSplit; newGameButton.disabled = !gameOver; hitButton.classList.remove('hint-highlight'); standButton.classList.remove('hint-highlight'); } // [cite: 569]
    function disableActionButtons() { hitButton.disabled = true; standButton.disabled = true; // [cite: 569]
        doubleDownButton.disabled = true; surrenderButton.disabled = true; splitButton.disabled = true; hitButton.classList.remove('hint-highlight'); standButton.classList.remove('hint-highlight'); // [cite: 570]
    }
    function enableBettingControls(enable) { // [cite: 571]
        // Logica sembra corretta: abilita/disabilita fiches e bottoni puntata
        clickableChipsContainer.querySelectorAll('.chip-button').forEach(chip => { const value = parseInt(chip.dataset.value); chip.disabled = !enable || value > playerBalance; }); // [cite: 571]
        placeBetButton.disabled = !enable || proposedBet === 0 || proposedBet > playerBalance; clearBetButton.disabled = !enable || proposedBet === 0; // [cite: 572]
        allInButton.disabled = !enable || playerBalance <= 0; restoreBetButton.disabled = !enable || lastBet <= 0 || lastBet > playerBalance; // [cite: 573]
        if (enable) { disableActionButtons(); newGameButton.disabled = true; } else { newGameButton.disabled = !gameOver; // [cite: 574]
        } }
    function updateBettingUI() { proposedBetDisplay.textContent = `Puntata: $${proposedBet}`; enableBettingControls(gameOver && playerBalance > 0); // [cite: 575]
    }
    function updateTrainerDisplay() { if (trainerControls.open) { // Controlla se <details> è aperto // [cite: 576]
            const decksRemaining = Math.max(0.5, Math.round((deck.length / 52) * 2) / 2); // [cite: 576]
            runningCountDisplay.textContent = runningCount; decksRemainingDisplay.textContent = decksRemaining.toFixed(1); trueCountDisplay.textContent = trueCount.toFixed(1); } } // [cite: 577]
    function updateStatsDisplay() { statsHandsDisplay.textContent = stats.handsPlayed; // [cite: 577]
        statsWinsDisplay.textContent = stats.wins; statsLossesDisplay.textContent = stats.losses; statsPushesDisplay.textContent = stats.pushes; statsBjsDisplay.textContent = stats.blackjacks; const totalDecisions = stats.wins + stats.losses; // [cite: 578]
        const winRate = totalDecisions > 0 ? ((stats.wins / totalDecisions) * 100).toFixed(1) + '%' : 'N/A'; statsWinRateDisplay.textContent = winRate; // [cite: 579]
    }

    // --- Result Popup Function (Invariato) ---
    function showResult(message, outcomeType = 'push') { clearTimeout(resultPopupTimeoutId); // [cite: 580]
        resultElement.textContent = message; resultElement.className = 'result'; resultElement.classList.add(`result-${outcomeType}`); resultElement.classList.add('result-show'); updateActionButtons(); resultPopupTimeoutId = setTimeout(() => { if (resultElement) { resultElement.classList.remove('result-show'); } }, 3500); // [cite: 581]
    }

    // --- Betting Actions (Invariati - Logica Sembra OK) ---
    function addChipValue(value) { if (!gameOver) return; // [cite: 582]
        // Logica sembra corretta: aggiunge valore se il saldo è sufficiente
        const numericValue = parseInt(value); if (isNaN(numericValue)) return; if (proposedBet + numericValue <= playerBalance) { proposedBet += numericValue; updateBettingUI(); // [cite: 583]
        } else { alert("Saldo insufficiente per aumentare la puntata."); } } // [cite: 584]
    function clearProposedBet() { if (!gameOver) return; // [cite: 584]
        proposedBet = 0; updateBettingUI(); } // [cite: 585]
    function playerAllIn() { if (!gameOver || playerBalance <= 0) return; // [cite: 585]
        proposedBet = playerBalance; updateBettingUI(); } // [cite: 586]
    function restoreBet() { if (!gameOver || lastBet <= 0) return; // [cite: 586]
        if (lastBet <= playerBalance) { proposedBet = lastBet; updateBettingUI(); } else { alert("Saldo insufficiente per ripristinare l'ultima puntata. Punta il massimo possibile."); // [cite: 587]
            proposedBet = playerBalance; updateBettingUI(); } } // [cite: 588]

    // --- Utility Functions (Modificate/Aggiunte) ---
    function showHiLoInfo() { alert("Conteggio Hi-Lo:\n\nAssegna un valore ad ogni carta vista:\n- Carte 2-6: +1\n- Carte 7-9: 0\n- Carte 10, J, Q, K, A: -1\n\n- Running Count: Somma dei valori di tutte le carte viste.\n- True Count: Running Count diviso per il numero di mazzi rimasti (stima).\n\nUn True Count alto indica che nel mazzo rimangono più carte alte (10, Assi), favorendo il giocatore. Un True Count basso o negativo indica più carte basse rimaste, favorendo il banco."); // [cite: 588]
    }
    function resetStats(update = true) { stats = { handsPlayed: 0, wins: 0, losses: 0, pushes: 0, blackjacks: 0 }; // [cite: 589]
        if (update) { saveGameState(); updateStatsDisplay(); console.log("Statistiche azzerate."); } } // [cite: 590]
    function toggleTheme() { const currentTheme = document.body.dataset.theme; // [cite: 590]
        const newTheme = currentTheme === 'dark' ? 'light' : 'dark'; document.body.dataset.theme = newTheme; themeToggle.checked = (newTheme === 'dark'); saveGameState(); // [cite: 591]
        /* Salva anche il tema */ } // [cite: 592]
    function toggleTrainingMode() { isTrainingMode = trainingModeToggle.checked; // [cite: 592]
        console.log("Modalità Allenamento Conteggio:", isTrainingMode ? "Attivata" : "Disattivata"); trainerControls.style.display = isTrainingMode ? '' : 'none'; // [cite: 593]
        /* Mostra/Nasconde trainer */ if(isTrainingMode) updateTrainerDisplay(); saveGameState(); /* Salva stato trainer */ } // [cite: 594]
    function toggleHints() { showHints = showHintsToggle.checked; // [cite: 594]
        console.log("Mostra Suggerimenti (Console):", showHints ? "Attivato" : "Disattivato"); if (showHints && !gameOver && playerHands.length > 0 && playerHands[currentPlayerHandIndex]?.status === 'active') { provideHint(); // [cite: 595]
        } }
    // --- CORREZIONE per il bottone "Cambia Gioco" ---
    function changeGame() {
        console.log("Tentativo di reindirizzamento a 'schermata iniziale.html'");
        // Assicurati che 'schermata iniziale.html' sia il nome corretto e il percorso giusto.
        // Se si trova nella stessa cartella, questo dovrebbe funzionare:
        window.location.href = 'schermata iniziale.html';
        // Se si trova in una cartella diversa, adegua il percorso, es: '../schermata iniziale.html' o '/path/to/schermata iniziale.html'
    }

    // --- Basic Strategy Hint (Invariati) ---
    function provideHint() { if (!showHints || gameOver || playerHands.length === 0 || !playerHands[currentPlayerHandIndex] || playerHands[currentPlayerHandIndex].status !== 'active') return; // [cite: 597]
        const playerHand = playerHands[currentPlayerHandIndex]; const playerCards = playerHand.cards; const playerValue = calculateHandValue(playerCards); const dealerCard = dealerHand.find(card => card.revealed); // [cite: 598]
        const dealerValue = dealerCard ? getCardValue(dealerCard.rank) : 0; let hint = "Azione Suggerita (Base): "; // [cite: 599]
        const isSoft = playerCards.some(c => c.rank === 'A') && playerValue !== calculateHandValue([{rank:'2', value:2, revealed: true}, ...playerCards.filter(c=> c.rank !== 'A')]); // [cite: 600]
        if (isSoft) { if (playerValue >= 19) hint += "Stai"; // [cite: 601]
        else if (playerValue === 18) hint += (dealerValue >= 9 || dealerValue === 11) ? "Carta" : "Stai"; // [cite: 602]
        else hint += "Carta"; } else { if (playerValue >= 17) hint += "Stai"; // [cite: 603]
        else if (playerValue <= 11) hint += "Carta"; else if (playerValue === 12) hint += (dealerValue >= 4 && dealerValue <= 6) ? // [cite: 604]
        "Stai" : "Carta"; else hint += (dealerValue >= 2 && dealerValue <= 6) ? "Stai" : "Carta"; } console.log(hint); highlightHintButton(hint); // [cite: 605]
    }
    function highlightHintButton(hintText) { hitButton.classList.remove('hint-highlight'); standButton.classList.remove('hint-highlight'); if (hintText.includes("Carta")) { hitButton.classList.add('hint-highlight'); } else if (hintText.includes("Stai")) { standButton.classList.add('hint-highlight'); // [cite: 606]
    } }

    // --- Event Listeners (Aggiornato per <details>) ---
    themeToggle.addEventListener('change', toggleTheme); // [cite: 607]
    trainingModeToggle.addEventListener('change', toggleTrainingMode); // [cite: 607]
    showHintsToggle.addEventListener('change', toggleHints); // [cite: 608]
    // Listener per click sulle fiches - Logica sembra corretta
    clickableChipsContainer.addEventListener('click', (event) => { if (event.target.classList.contains('chip-button')) { const value = event.target.dataset.value; addChipValue(value); } }); // [cite: 608]
    document.addEventListener('keydown', (event) => { if (gameOver && !newGameButton.disabled) { if (event.key === 'n' || event.key === 'N') { resetGame(true); } } else if (!gameOver && playerHands.length > 0 && playerHands[currentPlayerHandIndex]?.status === 'active') { switch (event.key) { case 'h': case 'H': if (!hitButton.disabled) playerHit(); break; case ' ': case 's': case 'S': if (!standButton.disabled) playerStand(); break; case 'd': case 'D': if (!doubleDownButton.disabled) playerDoubleDown(); break; case 'r': case 'R': if (!surrenderButton.disabled) playerSurrender(); break; case 'l': case 'L': if (!splitButton.disabled) playerSplit(); break; } } else if (gameOver && !placeBetButton.disabled) { if (event.key === 'Enter') { placeBet(); } } }); // [cite: 609]
    // Listener per salvare lo stato open/closed dei <details>
    utilityControls.addEventListener('toggle', saveGameState); // [cite: 610]
    sessionStats.addEventListener('toggle', saveGameState); // [cite: 610]
    trainerControls.addEventListener('toggle', () => { // [cite: 611]
        updateTrainerDisplay(); // Aggiorna display quando si apre/chiude
        saveGameState(); // [cite: 611]
    });


    // --- Initialization ---
    window.onload = () => { // [cite: 612]
        loadGameState(); // Carica stato salvato (include stato <details>) [cite: 612]
        // Imposta stato iniziale visualizzazione trainer basato su toggle
        trainerControls.style.display = trainingModeToggle.checked ? '' : 'none'; // [cite: 613]
        resetGame(false); // Inizia/resetta il gioco. Dovrebbe abilitare le puntate. [cite: 614]
    };
</script>
</body>
</html>
